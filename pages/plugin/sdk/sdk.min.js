"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var clientList={},listen=null,trigger=null,remove=null,removeAll=function(){clientList=[]},Event={listen:listen=function(t,e){clientList[t]||(clientList[t]=[]),clientList[t].push(e)},trigger:trigger=function(){var t=Array.prototype.slice.call(arguments),e=Array.prototype.shift.call(t),i=clientList[e];if(i&&0<=i.length)for(var s=0,n=i.length;s<n;s++)i[s].apply(null,t)},remove:remove=function(t,e){var i=clientList[t];if(!i)return!1;if(e)for(var s=i.length-1;0<=s;s--){i[s]===e&&i.splice(s,1)}else i&&(i.length=0);clientList[t]=i},removeAll:removeAll},V_EVENTE={EVENT_PLAY:"play",EVENT_PAUSE:"pause",EVENT_SEEK:"seek",EVENT_FULLSCREEN:"fullScreen",EVENT_EXIT_FULLSCREEN:"exitFullScreen",EVENT_AWAKE:"awakeUp",EVENT_CHANGESOURCE:"changeSource",EVENT_BACKRATE:"playbackRate"},ErrorCode={1e4:"消息体格式不正确",10001:"输入不能为空",10002:"当前用户被禁言",10003:"聊天输入不能超过140个字符",10004:"当前已开启全员禁言",10005:"当前活动不在直播",10006:"当前活动未开启问答",10007:"当前用户被踢出",2e4:"接口请求成功",20001:"验证信息不正确",20002:"回放状态，暂未开放...",20003:"接口请求失败",20004:"活动不存在",3e4:"准备就绪",4e4:"视频或者音频解析错误:开发工具不支持播放格式，请使用微信扫一扫!",40001:"直播中不能seek",40002:"视频等待缓冲中...",50400:"用户身份认证错误",50401:"用户发送消息频次超过限制",50402:"活动xxx发送消息频次超过限制",50403:"自定义广播消息内容长度超过限制"},EVENTE=V_EVENTE,Error=ErrorCode,timeOut=1e4,vhall="https://e.vhall.com/",pushLogUrl="https://la.e.vhall.com/login",videoDefault="https://cnstatic01.e.vhall.com/static/img/v35-webinar.png",noloading="https://cnstatic01.e.vhall.com/static/img/mobile/doc_noloading.png",Config=Object.freeze({__proto__:null,EVENTE:EVENTE,Error:Error,timeOut:timeOut,vhall:vhall,pushLogUrl:pushLogUrl,videoDefault:videoDefault,noloading:noloading});function play(){Event.trigger("control",EVENTE.EVENT_PLAY)}function pause(){Event.trigger("control",EVENTE.EVENT_PAUSE)}function seek(t){Event.trigger("control",EVENTE.EVENT_SEEK,t)}function fullScreen(t){0!=(t=t||0)&&90!=t&&-90!=t&&(t=0),Event.trigger("control",EVENTE.EVENT_FULLSCREEN,t)}function exitFullScreen(){Event.trigger("control",EVENTE.EVENT_EXIT_FULLSCREEN)}function changePlay(t){Event.trigger("control",EVENTE.EVENT_CHANGESOURCE,t)}function playbackRate(t){Event.trigger("control",EVENTE.EVENT_BACKRATE,t)}var Player={play:play,pause:pause,seek:seek,fullScreen:fullScreen,exitFullScreen:exitFullScreen,changePlay:changePlay,playbackRate:playbackRate,getPlaybackRate:[.5,.8,1,1.25,1.5,2]},crc32=function(t){for(var e=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],i=-1,s=0;s<t.length;s++)i=i>>>8^e[255&(i^t.charCodeAt(s))];return(-1^i)>>>0},base64encode=function(t){var e,i,s,n,o,a,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);for(s=t.length,i=0,e="";i<s;){if(n=255&t.charCodeAt(i++),i==s){e+=r.charAt(n>>2),e+=r.charAt((3&n)<<4),e+="==";break}if(o=t.charCodeAt(i++),i==s){e+=r.charAt(n>>2),e+=r.charAt((3&n)<<4|(240&o)>>4),e+=r.charAt((15&o)<<2),e+="=";break}a=t.charCodeAt(i++),e+=r.charAt(n>>2),e+=r.charAt((3&n)<<4|(240&o)>>4),e+=r.charAt((15&o)<<2|(192&a)>>6),e+=r.charAt(63&a)}return e},base64decode=function(t){var e,i,s,n,o,a,r;for(a=t.length,o=0,r="";o<a;){for(;e=base64DecodeChars[255&t.charCodeAt(o++)],o<a&&-1==e;);if(-1==e)break;for(;i=base64DecodeChars[255&t.charCodeAt(o++)],o<a&&-1==i;);if(-1==i)break;r+=String.fromCharCode(e<<2|(48&i)>>4);do{if(61==(s=255&t.charCodeAt(o++)))return r;s=base64DecodeChars[s]}while(o<a&&-1==s);if(-1==s)break;r+=String.fromCharCode((15&i)<<4|(60&s)>>2);do{if(61==(n=255&t.charCodeAt(o++)))return r;n=base64DecodeChars[n]}while(o<a&&-1==n);if(-1==n)break;r+=String.fromCharCode((3&s)<<6|n)}return r},videoUuid=function(t,e){var i,s,n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),o=[];if(e=e||n.length,t)for(i=0;i<t;i++)o[i]=n[0|Math.random()*e];else for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",i=0;i<36;i++)o[i]||(s=0|16*Math.random(),o[i]=n[19==i?3&s|8:s]);return o.join("")},public_func={base64encode:base64encode,base64decode:base64decode,videoUuid:videoUuid,crc32:crc32};function WxVideo(t,e){for(var i in this.defaultJson={wx:null,livePlayerKey:"",id_:"",type_:"rtmp",baseMode:"live",pushUrl:"",subSrc:[],catonChangeSrcMaxTime:10,useApi:!0,closePush:!1,dispatchDomain:"",vodQuality:["same"],uri:"",arguments:{id:"",s:"",p:"",uid:"",aid:"",pf:"",pd:"",vid:"",vfid:"",guid:"",vtype:"",topic:"",ua:"vhall-wxapp",bf:3,tt:null,_bc:0,ndi:"",_bt:0,host_user_id:"",browser:"",tf:0,rand:this.random(),ver:"",si:"",from:"",bu:"",app_id:"",biz_role:0,flow_type:2,biz_id:"-",biz_des01:0,playerType:"",paas_bu:"",paas_room_id:"",paas_uid:""}},this.context=e,t)if("arguments"==i)for(var s in t.arguments)this.defaultJson.arguments[s]=t.arguments[s];else this.defaultJson[i]=t[i];this.defaultJson.id_?this.defaultJson.wx?(this.defaultJson.arguments.s||(this.defaultJson.arguments.s=public_func.videoUuid(32,32)),this.defaultJson.arguments.vid||(this.defaultJson.arguments.vid="000000"),this.carltonCount=0,this.carltonReplay=0,this.currentTime=0,this.currentCartonTime=0,this.tt=0,this.heartTT=0,this.randomSwitchSrcCount=0,this.isFull=!1,this.ttTimer=null,this.liveInfoTimer=null,this.minuteHeartLiveTimer=null,this.carltonTimer=null,this.currentSrc="",this.fetchRs=null,this.firstPush=!1,this.vodInfoTimer=null,this.minuteHeartVodTimer=null,this._token={token:null,date:0},this.player=t.player?t.player:null,this.oldDetail=null,this._switchIng=!1,this.vodPlayStatus=!1,this.url=this.defaultJson.pushUrl||"http://t-dc.e.vhall.com/login"):console.log("wx object is must!"):console.log("need dom id")}WxVideo.prototype.getSrc=function(){return this.defaultJson.useApi?"":this.defaultJson.subSrc[0]},WxVideo.prototype.switchStatus=function(){return this._switchIng},WxVideo.prototype.updateLivePlayerSrc=function(t){var e={};e[this.defaultJson.livePlayerKey]=t+"?token="+this._token.token,this._switchIng=!0,this.context.setData(e),this.oldDetail=null,this.stopAllTimer(),this.sleep(2e3),this.player||("live"==this.defaultJson.baseMode?this.player=this.defaultJson.wx.createLivePlayerContext(this.defaultJson.id_):this.player=this.defaultJson.wx.createVideoContext(this.defaultJson.id_)),this._play(this),this.currentSrc=t,"vod"==this.defaultJson.baseMode&&this._currentTime()&&this.player.seek(this._currentTime())},WxVideo.prototype.sleep=function(t){for(var e=(new Date).getTime();(new Date).getTime()<e+t;);},WxVideo.prototype.play=function(){var e=this;this.defaultJson.useApi?this.fetchSrc({callback:function(t){e.currentSrc=t.currentSrc,e.updateLivePlayerSrc(e.currentSrc)}}):this._switchSrc()},WxVideo.prototype._play=function(t){"live"==this.defaultJson.baseMode?this.player.play({success:function(){t.firstPush||(t.fristLiveStartPlayPush(),t.firstPush=!0)},fail:function(){t.liveFirstPlayErrorPush(),t._switchSrc()},complete:function(){}}):(this.player.play(),this.vodPlayStatus||(this.firstVodStartPlayPush(),this.vodPlayStatus=!0))},WxVideo.prototype.stop=function(){"live"==this.defaultJson.baseMode&&(this.player.stop(),this.stopAllTimer(),this._liveInfo(this,2002))},WxVideo.prototype.onBindPlay=function(){if(this.startTimer(),this.vodPlayStatus){var t=public_func.base64encode(JSON.stringify({s:this.defaultJson.arguments.s,p:this.defaultJson.arguments.p,uid:this.defaultJson.arguments.uid,aid:this.defaultJson.arguments.aid,pf:this.defaultJson.arguments.pf,ver:this.defaultJson.arguments.ver,vid:this.defaultJson.arguments.vid,vfid:this.defaultJson.arguments.vfid,ndi:this.defaultJson.arguments.ndi,guid:this.defaultJson.arguments.guid,vtype:this.defaultJson.arguments.vtype,topic:this.defaultJson.arguments.topic,fd:this.splitSrc().fd,sd:this.splitSrc().sd,errcode:2002,si:this.defaultJson.arguments.si,from:this.defaultJson.arguments.from,app_id:this.defaultJson.arguments.app_id,biz_role:this.defaultJson.arguments.biz_role,flow_type:this.defaultJson.arguments.flow_type,biz_id:this.defaultJson.arguments.biz_id,biz_des01:this.defaultJson.arguments.biz_des01})),e=this.url+"?k=92004&id="+this.createId()+"&s="+this.defaultJson.arguments.s+"&bu="+this.defaultJson.arguments.bu+"&token="+t;this.defaultJson.wx.request({url:e,method:"GET",success:function(t){console.log("vod start play push finish")},fail:function(t){console.log("vod start play push fail"),console.log(t),console.log(e)}})}},WxVideo.prototype.onBindPause=function(){this.stopAllTimer(),this._vodInfo(this,2002);var t=public_func.base64encode(JSON.stringify({s:this.defaultJson.arguments.s,p:this.defaultJson.arguments.p,uid:this.defaultJson.arguments.uid,aid:this.defaultJson.arguments.aid,pf:this.defaultJson.arguments.pf,vid:this.defaultJson.arguments.vid,vfid:this.defaultJson.arguments.vfid,ndi:this.defaultJson.arguments.ndi,guid:this.defaultJson.arguments.guid,vtype:this.defaultJson.arguments.vtype,topic:this.defaultJson.arguments.topic,app_id:this.defaultJson.arguments.app_id,biz_role:this.defaultJson.arguments.biz_role,flow_type:this.defaultJson.arguments.flow_type,biz_id:this.defaultJson.arguments.biz_id,biz_des01:this.defaultJson.arguments.biz_des01})),e=this.url+"?k=92002&id="+this.createId()+"&s="+this.defaultJson.arguments.s+"&bu="+this.defaultJson.arguments.bu+"&token="+t;this.defaultJson.wx.request({url:e,method:"GET",success:function(t){console.log("vod pause start play push finish")},fail:function(t){console.log("vod pause start play push fail"),console.log(t)}})},WxVideo.prototype.onBindEnd=function(){this.stopAllTimer(),this._vodInfo(this,2002),this.vodPlayStatus=!1},WxVideo.prototype.onError=function(){this.stopAllTimer(),this._liveInfo(this,4001),this._switchSrc()},WxVideo.prototype.changeScreen=function(t){this.isFull?(this.player.exitFullScreen(),this.isFull=!1):(this.player.requestFullScreen(t),this.isFull=!0)},WxVideo.prototype.random=function(){var t=[1,2,3,4,5,6,7,8,9];return parseInt(String(t[Math.floor(Math.random()*t.length)])+String(t[Math.floor(Math.random()*t.length)])+String(t[Math.floor(Math.random()*t.length)]))},WxVideo.prototype.createId=function(){return(new Date).getTime()+this.random()},WxVideo.prototype._currentTime=function(){return this.currentTime},WxVideo.prototype.splitSrc=function(){var t="",e="";return this.currentSrc&&(t=this.currentSrc.split(".com/")[1],e=this.currentSrc.split(".com/")[0]),{fd:t,sd:e}},WxVideo.prototype.startTimer=function(){this.ttCounter(),"live"==this.defaultJson.baseMode?(this.liveInfo(),this.liveHeart()):(this.vodInfo(),this.vodHeart())},WxVideo.prototype.stopAllTimer=function(){this.ttTimer&&(clearInterval(this.ttTimer),this.ttTimer=null),this.liveInfoTimer&&(clearInterval(this.liveInfoTimer),this.liveInfoTimer=null),this.vodInfoTimer&&(console.log("close vodinfotimer"),clearInterval(this.vodInfoTimer),this.vodInfoTimer=null),this.minuteHeartVodTimer&&(clearInterval(this.minuteHeartVodTimer),this.minuteHeartVodTimer=null),this.minuteHeartLiveTimer&&(clearInterval(this.minuteHeartLiveTimer),this.minuteHeartLiveTimer=null),this.carltonTimer&&(clearInterval(this.carltonTimer),this.carltonTimer=null)},WxVideo.prototype.ttCounter=function(){var t=this;t.ttTimer||(t.ttTimer=setInterval(function(){t.tt++,t.heartTT++,t.currentTime++},1e3))},WxVideo.prototype.firstVodStartPlayPush=function(){this.isFirst=!1,this._startPlayPush()},WxVideo.prototype._startPlayPush=function(){var t=public_func.base64encode(JSON.stringify({s:this.defaultJson.arguments.s,p:this.defaultJson.arguments.p,uid:this.defaultJson.arguments.uid,aid:this.defaultJson.arguments.aid,pf:this.defaultJson.arguments.pf,vid:this.defaultJson.arguments.vid,vfid:this.defaultJson.arguments.vfid,ndi:this.defaultJson.arguments.ndi,guid:this.defaultJson.arguments.guid,vtype:this.defaultJson.arguments.vtype,topic:this.defaultJson.arguments.topic,app_id:this.defaultJson.arguments.app_id,biz_role:this.defaultJson.arguments.biz_role,flow_type:this.defaultJson.arguments.flow_type,biz_id:this.defaultJson.arguments.biz_id,biz_des01:this.defaultJson.arguments.biz_des01})),e=this.url+"?k=92001&id="+this.createId()+"&s="+this.defaultJson.arguments.s+"&bu="+this.defaultJson.arguments.bu+"&token="+t;this.defaultJson.wx.request({url:e,method:"GET",success:function(t){console.log("vod start play push finish")},fail:function(t){console.log("vod start play push fail"),console.log(t)}})},WxVideo.prototype.vodInfo=function(){this.vodInfoTimer||(this.vodInfoTimer=setInterval(this._vodInfo,3e4,this,2002))},WxVideo.prototype._vodInfo=function(e,t){var i=public_func.base64encode(JSON.stringify({s:e.defaultJson.arguments.s,p:e.defaultJson.arguments.p,uid:e.defaultJson.arguments.uid,aid:e.defaultJson.arguments.aid,pf:e.defaultJson.arguments.pf,ver:e.defaultJson.arguments.ver,vid:e.defaultJson.arguments.vid,vfid:e.defaultJson.arguments.vfid,ndi:e.defaultJson.arguments.ndi,guid:e.defaultJson.arguments.guid,vtype:e.defaultJson.arguments.vtype,topic:e.defaultJson.arguments.topic,fd:e.splitSrc().fd,tt:1e3*e.tt,sd:e.splitSrc().sd,errcode:t,si:e.defaultJson.arguments.si,from:e.defaultJson.arguments.from,app_id:e.defaultJson.arguments.app_id,biz_role:e.defaultJson.arguments.biz_role,flow_type:e.defaultJson.arguments.flow_type,biz_id:e.defaultJson.arguments.biz_id,biz_des01:e.defaultJson.arguments.biz_des01})),s=e.url+"?k=92002&id="+e.createId()+"&s="+e.defaultJson.arguments.s+"&bu="+e.defaultJson.arguments.bu+"&token="+i;console.log("test",s),e.defaultJson.wx.request({url:s,method:"GET",success:function(t){e.tt=0,console.log("vodinfo start play push finish")},fail:function(t){console.log("vodinfo start play push fail"),console.log(t),console.log(s)}})},WxVideo.prototype.vodHeart=function(){var i=this;this.minuteHeartVodTimer||(this.minuteHeartVodTimer=setInterval(function(){var t=public_func.base64encode(JSON.stringify({s:i.defaultJson.arguments.s,p:i.defaultJson.arguments.p,uid:i.defaultJson.arguments.uid,aid:i.defaultJson.arguments.aid,pf:i.defaultJson.arguments.pf,fd:i.splitSrc().fd,si:i.defaultJson.arguments.si,sd:i.splitSrc().sd,tt:1e3*i.heartTT,ua:i.defaultJson.arguments.ua,vid:i.defaultJson.arguments.vid,vfid:i.defaultJson.arguments.vfid,ndi:i.defaultJson.arguments.ndi,guid:i.defaultJson.arguments.guid,vtype:i.defaultJson.arguments.vtype,topic:i.defaultJson.arguments.topic,host_user_id:"",brower:"",tf:"",app_id:i.defaultJson.arguments.app_id,biz_role:i.defaultJson.arguments.biz_role,flow_type:i.defaultJson.arguments.flow_type,biz_id:i.defaultJson.arguments.biz_id,biz_des01:i.defaultJson.arguments.biz_des01})),e=i.url+"?k=92003&id="+i.createId()+"&s="+i.defaultJson.arguments.s+"&bu="+i.defaultJson.arguments.bu+"&token="+t;i.defaultJson.wx.request({url:e,method:"GET",success:function(t){i.heartTT=0,console.log("vod heart push finish")},fail:function(t){console.log("vod heart push fail")}}),i.heartTT=0},6e4))},WxVideo.prototype.fristLiveStartPlayPush=function(){this._liveStartPlayPush()},WxVideo.prototype._liveStartPlayPush=function(){var t=public_func.base64encode(JSON.stringify({s:this.defaultJson.arguments.s,uid:this.defaultJson.arguments.uid,aid:this.defaultJson.arguments.aid,pf:this.defaultJson.arguments.pf,ver:this.defaultJson.arguments.ver,vid:this.defaultJson.arguments.vid,vfid:this.defaultJson.arguments.vfid,ndi:this.defaultJson.arguments.ndi,guid:this.defaultJson.arguments.guid,vtype:this.defaultJson.arguments.vtype,topic:this.defaultJson.arguments.topic,app_id:this.defaultJson.arguments.app_id,biz_role:this.defaultJson.arguments.biz_role,flow_type:this.defaultJson.arguments.flow_type,biz_id:this.defaultJson.arguments.biz_id,biz_des01:this.defaultJson.arguments.biz_des01})),e=this.url+"?k=102001&id="+this.createId()+"&s="+this.defaultJson.arguments.s+"&bu="+this.defaultJson.arguments.bu+"&token="+t;this.defaultJson.wx.request({url:e,method:"GET",success:function(t){console.log("start play push finish")},fail:function(t){console.log("start play push fail"),console.log(t)}})},WxVideo.prototype.liveInfo=function(){this.liveInfoTimer||(this.liveInfoTimer=setInterval(this._liveInfo,3e4,this,2002))},WxVideo.prototype._liveInfo=function(t,e){var i=public_func.base64encode(JSON.stringify({s:t.defaultJson.arguments.s,p:t.defaultJson.arguments.p,uid:t.defaultJson.arguments.uid,aid:t.defaultJson.arguments.aid,pf:t.defaultJson.arguments.pf,ver:t.defaultJson.arguments.ver,vid:t.defaultJson.arguments.vid,vfid:t.defaultJson.arguments.vfid,ndi:t.defaultJson.arguments.ndi,guid:t.defaultJson.arguments.guid,vtype:t.defaultJson.arguments.vtype,topic:t.defaultJson.arguments.topic,fd:t.splitSrc().fd,tt:1e3*t.tt,bc:t.carltonCount,bt:t.carltonReplay,sd:t.splitSrc().sd,errcode:e,si:t.defaultJson.arguments.si,from:t.defaultJson.arguments.from,app_id:t.defaultJson.arguments.app_id,biz_role:t.defaultJson.arguments.biz_role,flow_type:t.defaultJson.arguments.flow_type,biz_id:t.defaultJson.arguments.biz_id,biz_des01:t.defaultJson.arguments.biz_des01})),s=t.url+"?k=102002&id="+t.createId()+"&s="+t.defaultJson.arguments.s+"&bu="+t.defaultJson.arguments.bu+"&token="+i;t.defaultJson.wx.request({url:s,method:"GET",success:function(t){console.log("info push finish")},fail:function(t){console.log("info push fail")}}),t.tt=0,t.carltonCount=0,t.carltonReplay=0},WxVideo.prototype.liveHeart=function(){var i=this;this.minuteHeartLiveTimer||(this.minuteHeartLiveTimer=setInterval(function(){var t=public_func.base64encode(JSON.stringify({s:i.defaultJson.arguments.s,p:i.defaultJson.arguments.p,uid:i.defaultJson.arguments.uid,aid:i.defaultJson.arguments.aid,pf:i.defaultJson.arguments.pf,fd:i.splitSrc().fd,si:i.defaultJson.arguments.si,sd:i.splitSrc().sd,tt:1e3*i.heartTT,ua:i.defaultJson.arguments.ua,vid:i.defaultJson.arguments.vid,vfid:i.defaultJson.arguments.vfid,ndi:i.defaultJson.arguments.ndi,guid:i.defaultJson.arguments.guid,vtype:i.defaultJson.arguments.vtype,topic:i.defaultJson.arguments.topic,host_user_id:"",brower:"",tf:"",app_id:i.defaultJson.arguments.app_id,biz_role:i.defaultJson.arguments.biz_role,flow_type:i.defaultJson.arguments.flow_type,biz_id:i.defaultJson.arguments.biz_id,biz_des01:i.defaultJson.arguments.biz_des01})),e=i.url+"?k=102003&id="+i.createId()+"&s="+i.defaultJson.arguments.s+"&bu="+i.defaultJson.arguments.bu+"&token="+t;i.defaultJson.wx.request({url:e,method:"GET",success:function(t){console.log("heart push finish")},fail:function(t){console.log("heart push fail")}}),i.heartTT=0},6e4))},WxVideo.prototype.liveFirstPlayErrorPush=function(){var t=this,e=public_func.base64encode(JSON.stringify({s:t.defaultJson.arguments.s,p:t.defaultJson.arguments.p,uid:t.defaultJson.arguments.uid,aid:t.defaultJson.arguments.aid,pf:t.defaultJson.arguments.pf,ver:t.defaultJson.arguments.ver,fd:t.splitSrc().fd,errcode:4001,si:t.defaultJson.arguments.si,sd:t.splitSrc().sd,vid:t.defaultJson.arguments.vid,vfid:t.defaultJson.arguments.vfid,ndi:t.defaultJson.arguments.ndi,guid:t.defaultJson.arguments.guid,vtype:t.defaultJson.arguments.vtype,topic:t.defaultJson.arguments.topic,app_id:t.defaultJson.arguments.app_id,biz_role:t.defaultJson.arguments.biz_role,flow_type:t.defaultJson.arguments.flow_type,biz_id:t.defaultJson.arguments.biz_id,biz_des01:t.defaultJson.arguments.biz_des01})),i=t.url+"?k=104001&id="+t.createId()+"&s="+t.defaultJson.arguments.s+"&bu="+t.defaultJson.arguments.bu+"&token="+e;t.defaultJson.wx.request({url:i,method:"GET",success:function(t){console.log("start fail push finish")},fail:function(t){console.log("start fail push fail")}})},WxVideo.prototype.checkToken=function(){var t=(new Date).getTime();return console.log("token date",t-this._token.date),!(3e5<=t-this._token.date)},WxVideo.prototype.fetchSrc=function(t){if(this.defaultJson.useApi){var e=this.defaultJson.arguments,a={qualityStr:"480p",callback:null};for(var u in t)a[u]=t[u];var i=this.defaultJson.wx;if("live"==this.defaultJson.baseMode){var s=this.defaultJson.dispatchDomain+"/api/dispatch_play?webinar_id="+e.aid+"&rand="+e.rand+"&uid="+e.uid+"&bu="+e.bu;2===this.defaultJson.playerType&&(s=this.defaultJson.dispatchDomain+"/api/dispatch_play?webinar_id="+e.paas_room_id+"&rand="+e.rand+"&uid="+e.paas_uid+"&bu="+e.paas_bu)}else s=this.defaultJson.dispatchDomain+"/api/dispatch_replay?webinar_id="+e.aid+"&rand="+e.rand+"&uid="+e.uid+"&bu="+e.bu+"&quality="+JSON.stringify(this.defaultJson.vodQuality)+"&uri="+this.defaultJson.uri;console.log(s);var d=this;i.request({url:s,method:"GET",success:function(t){var e=t.data;if("success"==e.msg&&"200"==e.code){var i=e.data,s=i.token,n=public_func.crc32(s.split("_")[0].split("").reverse().join("")).toString(16).toUpperCase()+"_"+s.split("_")[1];if("live"==d.defaultJson.baseMode)if("flv"==d.defaultJson.type_){d.viewUrl=i.httpflv_urls;var o=r(d.viewUrl,"httpflv_url",n,a.qualityStr)}else{d.viewUrl=i.rtmp_urls;o=r(d.viewUrl,"rtmp_url",n,a.qualityStr)}else if("hls"==d.defaultJson.type_){d.viewUrl=i.hls_domainnames;o=r(d.viewUrl,"hls_domainname",n,a.qualityStr)}else{d.viewUrl=i.mp4_domainnames;o=r(d.viewUrl,"mp4_domainname",n,a.qualityStr)}o.token=n,o.currentSrc=d.defaultJson.subSrc[0],d.currentSrc=o.currentSrc,d._token={token:n,date:(new Date).getTime()},a.callback&&a.callback(o)}},fail:function(t){}})}function r(t,e,i,s){var n=!1,o=[];for(u in t)u==s&&(n=!0),o.push(u);var a=n?s:"same";d.defaultJson.subSrc=[];for(var r=0,l=t[a].length;r<l;r++)d.defaultJson.subSrc.push(t[a][r][e]);return d.subSrcMaxIndex=d.defaultJson.subSrc.length-1,d.subSrcIndex=0,d.choiceClearStatus=o,{currentClearStatus:d.currentClearStatus=a,choiceClearStatus:o}}},WxVideo.prototype.switchSrc=function(){var t,e=this.defaultJson.subSrc;if(1==arguments.length)t=arguments[0];else{if(e<=1)return void console.log("current Src length <= 1, so can not switch src");this.subSrcIndex>=this.subSrcMaxIndex?(this.subSrcIndex=0,this.randomSwitchSrcCount++):this.subSrcIndex++,t=e[this.subSrcIndex]}return t},WxVideo.prototype.switchQualityLevel=function(t){var e=this.viewUrl[t];if(e){if("flv"==this.defaultJson.type)var i="httpflv_url";else i="rtmp_url";this.defaultJson.subSrc=[];for(var s=0,n=e.length;s<n;s++)this.defaultJson.subSrc.push(e[s][i]);this.subSrcMaxIndex=this.defaultJson.subSrc.length-1,this.subSrcIndex=0,this.currentClearStatus=t,this.updateLivePlayerSrc(this.switchSrc(this.defaultJson.subSrc[0]))}else console.log("no this quality")},WxVideo.prototype._switchSrc=function(){var e=this;e.defaultJson.useApi?e.checkToken()?2<=e.randomSwitchSrcCount?"same"!=e.currentClearStatus&&e.switchQualityLevel("same"):e.updateLivePlayerSrc(e.switchSrc()):e.fetchSrc({qualityStr:e.currentClearStatus||"480p",callback:function(t){t&&t.currentSrc&&(2<=e.randomSwitchSrcCount?"same"!=e.currentClearStatus&&e.switchQualityLevel("same"):e.updateLivePlayerSrc(e.switchSrc()))}}):1<e.defaultJson.subSrc.length?e.updateLivePlayerSrc(e.switchSrc()):1==e.defaultJson.subSrc.length?e.updateLivePlayerSrc(e.getSrc()):console.log("subSrc not src to play!")},WxVideo.prototype.bindstatechange=function(t){if(t){var e=this;if(2105==t){if(e.oldDetail==t)return;if(this.carltonTimer)return;console.log("kadun"),this.ttTimer&&(clearInterval(this.ttTimer),this.ttTimer=null),this.stopAllTimer(),this.carltonCount++,this.carltonTimer=setInterval(function(){e.carltonReplay++,e.currentCartonTime++,e.currentCartonTime>=e.defaultJson.catonChangeSrcMaxTime&&(e._switchSrc(),e.currentCartonTime=0)},1e3),e.oldDetail=t}else if(this.carltonTimer&&(console.log("kadun huifu"),clearInterval(this.carltonTimer),this.carltonTimer=null,this.ttCounter(),this.currentCartonTime=0),2006==t)e.oldDetail,console.log("jieshou"),this.stopAllTimer();else if(2101==t||2102==t||3001==t||3002==t||3003==t||3005==t)console.log("yichang",t),e.oldDetail=t,e.stopAllTimer(),e._liveInfo(e,4001),e._switchSrc();else if(t=2004){if(e._switchIng=!1,e.oldDetail==t)return;console.log("kaibo",t),e.startTimer(),e.oldDetail=t}}else console.log("no detail")};var video=WxVideo;function get(t,s,e){var n=Config[e]||vhall;return n+=t,-1!=t.indexOf("https://")&&(n=t),new Promise(function(e,i){wx.request({url:n+"?_="+(new Date).getTime(),data:s,header:{"content-type":"application/json"},success:function(t){e(t)},fail:function(t){i(t)}})})}function post(t,s,e){var n=Config[e]||vhall;return new Promise(function(e,i){wx.request({url:n+t,data:s,method:"POST",header:{"content-type":"application/json"},success:function(t){e(t)},fail:function(t){i(t)}})})}var Http={reqGet:get,reqPost:post};function login(t){var e={roomid:t.roomid,account:t.account,username:t.username,app_key:t.app_key,signedat:t.signedat,sign:t.sign};return Http.reqGet("api/miniprogram/v1/webinar/init",e)}function getDocs(t){return Http.reqGet("https:"+t)}var Login={login:login,getDocs:getDocs};function init(t){if(void 0===t)return t={},Event.trigger("error",{code:"20001",msg:Error[20001]}),console.error("请先阅读文档传入正确参数");if(!(t.roomid&&t.app_key&&t.signedat&&t.sign&&t.username))return Event.trigger("error",{code:"20001",msg:Error[20001]}),console.error("有必填项未填");var e={account:t.account,email:t.email,roomid:t.roomid,username:t.username,app_key:t.app_key,signedat:t.signedat,sign:t.sign};return Login.login(e)}function getDocs$1(t){return Login.getDocs(t)}var VhallMain={init:init,getDocs:getDocs$1,on:Event.listen,remove:Event.remove,removeAll:Event.removeAll};function countColor(t){return"#"+t.toString(16).padStart(6,"0")}function drawLine(t,e){t.setStrokeStyle(countColor(e.color)),t.setLineWidth(e.lineWidth*e.ratio),t.setLineCap("round"),t.moveTo(e.data[0][0]*e.ratio,e.data[0][1]*e.ratio);for(var i=0;i<e.data.length;i++){var s=e.data[i];t.lineTo(s[0]*e.ratio,s[1]*e.ratio)}t.stroke(),t.draw(!0)}function drawEllipse(t,e){var i,s,n=e,o=0,a=0;20===n.type?(o=(n.tPoint[0]-n.sPoint[0])/2*n.ratio,a=(n.tPoint[1]-n.sPoint[1])/2*n.ratio):21===n.type&&(o=a=(Math.abs(n.tPoint[0]-n.sPoint[0])>Math.abs(n.tPoint[1]-n.sPoint[1])?n.tPoint[1]-n.sPoint[1]:n.tPoint[0]-n.sPoint[0])/2*n.ratio),i=n.sPoint[0]*n.ratio+o,s=n.sPoint[1]*n.ratio+a;var r=(o+a)/2;t.arc(i,s,r,0,2*Math.PI,!0),t.setStrokeStyle(countColor(e.color)),t.setLineWidth(e.lineWidth*e.ratio),t.stroke(),t.draw(!0)}function drawRect(t,e){var i=e;t.setStrokeStyle(countColor(i.color)),t.setLineWidth(e.lineWidth*i.ratio),t.strokeRect(i.sPoint[0]*i.ratio,i.sPoint[1]*i.ratio,(i.tPoint[0]-i.sPoint[0])*i.ratio,(i.tPoint[1]-i.sPoint[1])*i.ratio),t.draw(!0)}function drawText(t,e){var i=e,s="";1===i.fi&&(s+="italic "),1===i.fb&&(s+="bold "),s+=i.fs*i.ratio+"px 'Microsoft YaHei'",t.font=s,t.setFontSize(i.fs),t.setFillStyle(countColor(i.color)),t.fillText(unescape(i.ft),i.sPoint[0]*i.ratio,i.sPoint[1]*i.ratio),t.draw(!0)}function drawArrow(t,e){var i=t,s=e,n=s.sPoint[0]*e.ratio,o=s.sPoint[1]*e.ratio,a=s.tPoint[0]*e.ratio,r=s.tPoint[1]*e.ratio,l=countColor(s.color),u=180*Math.atan2(o-r,n-a)/Math.PI,d=(30+u)*Math.PI/180,c=(u-30)*Math.PI/180,f=5*Math.cos(d),h=5*Math.sin(d),p=5*Math.cos(c),g=5*Math.sin(c);if(i.save(),i.beginPath(),i.moveTo(n,o),i.lineTo(a,r),31===s.type){var m=n-f,v=o-h;i.moveTo(m,v),i.lineTo(n,o);var J=n-p,y=o-g;i.lineTo(J,y),i.moveTo(n,o),i.lineTo(a,r)}var _=a+f,b=r+h;i.moveTo(_,b),i.lineTo(a,r);var S=a+p,T=r+g;i.lineTo(S,T),i.setFillStyle(l),i.setStrokeStyle(l),i.setLineWidth(2),i.fill(),i.stroke(),i.restore(),t.draw(!0)}function drawAnchor(t,e){var i=t,s=e,n=10*s.ratio;i.fillStyle=countColor(s.color),i.setFillStyle(countColor(s.color));var o=s.sPoint[0]*s.ratio,a=s.sPoint[1]*s.ratio;i.beginPath(),i.arc(o+n,a+n,n,0,2*Math.PI),i.closePath(),i.fill(),i.beginPath(),i.moveTo(o,a+n+2),i.lineTo(o+2*n,a+n+2),i.lineTo(o+n,a+3*n),i.closePath(),i.fill(),i.setFillStyle("rgba(0,0,0,0)"),i.beginPath(),i.arc(o+n,a+n,.55*n,0,2*Math.PI),i.closePath(),i.fill(),t.draw(!0)}function clearDraw(t,e){4==e.length?(t.clearRect(e[0],e[1],e[2],e[3]),t.draw()):console.error("clearDraw传入参数不正确!")}var DrawUtil={drawLine:drawLine,drawEllipse:drawEllipse,drawRect:drawRect,drawText:drawText,drawArrow:drawArrow,drawAnchor:drawAnchor,clearDraw:clearDraw};function sendDocMsg(t,e){e=parseInt(e);for(var i=0;i<t.length;i++){var s=t[i];e==s.updataTime&&(Event.trigger("flashMsgDoc",s.doc),t.splice(i,1),i--)}}function formartDocs(t){for(var e=[],i=0;i<t.cuepoint.length;i++){var s=t.cuepoint[i],n=s.content;n=n.replace(/\\"/g,'"'),e.push({doc:JSON.parse(n),updataTime:parseInt(s.created_at)})}return e}var docHelp={formartDocs:formartDocs,sendDocMsg:sendDocMsg},io=require("./weapp.socket.io.js"),socket={init:function(t){var e=this,i="wss://"+t.socketSrv+"?app=vhall&token="+t.socketToken+"&transport=websocket&_="+(new Date).getTime(),s=io(i);return s.open(),s.on("flashMsg",function(t){t=e.transData(t),Event.trigger("flashMsgDoc",t)}),s.on("cmd",function(t){"*watchDisplay"==(t=e.transData(t)).type?Event.trigger("flashMsgDoc",t):Event.trigger("cmdMsg",t)}),s.on("online",function(t){t=e.transData(t),Event.trigger("onlineMsg",t)}),wx.onNetworkStatusChange(function(t){t.isConnected&&s&&s.open()}),s},transData:function(t){return"string"==typeof t&&(t=JSON.parse(t)),t}},Vhall={Event:Event,Player:Player,VideoJs:video,VhallMain:VhallMain,DrawUtil:DrawUtil,DocHelp:docHelp,Socket:socket},index={play:Player.play,seek:Player.seek,pause:Player.pause,fullScreen:Player.fullScreen,exitFullScreen:Player.exitFullScreen,changePlaySource:Player.changePlay,playbackRate:Player.playbackRate,getPlaybackRate:Player.getPlaybackRate,setOptions:function(t){Event.trigger("initVhall",t)}};exports.Vhall=Vhall,exports.default=index;
